---
- hosts: localhost
  gather_facts: False
  tasks:
  - name: provision a test node
    local_action:
      module: rax
      credentials: ~/.raxpub
      region: IAD
      name: base-test
      flavor: performance1-1
      image: 5cc098a5-7286-4b96-b3a2-49f4c4f82537
      key_name: jphelps
      wait: yes
      state: present
      networks:
        - private
        - public
      group: tests
    register: rax

  - name: add server to group
    local_action:
      module: add_host
      hostname: "{{ item.name }}"
      ansible_ssh_host: "{{ item.rax_accessipv4 }}"
      ansible_ssh_pass: "{{ item.rax_adminpass }}"
      ansible_ssh_user: root
      groupname: tests
    with_items: rax.success
    when: rax.action == 'create'

  - name: wait for ssh
    local_action:
      module: wait_for
      port: 22
      delay: 10
      host: "{{ item.rax_accessipv4 }}"
    with_items: rax.success

- hosts: tests
  roles:
    - Rackspace_Automation.base
